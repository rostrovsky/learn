<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0f172a; /* slate-900 */
      --muted: #64748b; /* slate-500 */
      --accent: #111827; /* gray-900 */
      --accent-2: #e5e7eb; /* gray-200 */
      --ring: #1f2937; /* gray-800 */
      --card: #ffffff;
      --shadow: 0 8px 24px rgba(2, 6, 23, 0.08);
      --radius: 18px;
      --primary: #7c3aed; /* purple-600 */
      --primary-hover: #6d28d9; /* purple-700 */
      --correct: #16a34a; /* green-600 */
      --incorrect: #dc2626; /* red-600 */
      --chip: #f3f4f6; /* gray-100 */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI,
      Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--fg);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      touch-action: manipulation;
    }

    .container { 
      max-width: 960px; 
      margin: 0 auto; 
      padding: 0 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-content { flex: 1; }

    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 18px; padding-top: 20px; }
    header h1 { font-size: clamp(20px, 2.5vw, 28px); margin: 0; letter-spacing: -0.02em; }
    header .subtitle { color: var(--muted); font-size: 14px; }

    .btn {
      appearance: none; border: 1px solid var(--accent-2); background: #fff; color: var(--fg);
      border-radius: 12px; padding: 10px 14px; font-size: 14px; cursor: pointer; 
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
      box-shadow: 0 1px 0 rgba(2,6,23,0.02);
    }
    .btn:hover { border-color: #cbd5e1; }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity: .45; cursor: not-allowed; }

    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      font-weight: 500;
    }
    .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }

    .controls { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 18px 0 8px; flex-wrap: wrap; }
    .controls .left, .controls .right { display: flex; gap: 8px; align-items: center; }

    .counter { color: var(--muted); font-size: 13px; }
    .title { font-weight: 600; }

    .card {
      position: relative;
      min-height: 220px;
      padding: clamp(18px, 3vw, 28px);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      border: 1px solid rgba(100,116,139,0.12);
      display: grid;
      align-items: start;
    }

    .prompt { font-size: clamp(18px, 2.4vw, 26px); line-height: 1.35; letter-spacing: -0.01em; margin-bottom: 12px; }
    .choices { display: grid; gap: 10px; margin-top: 8px; }
    .choice {
      display: grid; grid-template-columns: 24px 1fr; gap: 10px; align-items: start;
      padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(100,116,139,0.18);
      background: #fff;
    }
    .choice.disabled { opacity: .7; }
    .choice.correct { border-color: rgba(22,163,74,.45); background: #f0fdf4; }
    .choice.incorrect { border-color: rgba(220,38,38,.45); background: #fef2f2; }
    .choice .label { margin-top: -2px; }

    .hint { color: var(--muted); font-size: 12px; text-align: center; margin-top: 10px; }
    .errors .error { background: #fef2f2; border: 1px solid #fecaca; color: #7f1d1d; padding: 12px 14px; border-radius: 12px; font-size: 14px; }
    .error + .error { margin-top: 8px; }

    .hidden { display: none !important; }
    #progress { text-align: center; margin: 12px 0; color: var(--muted); font-size: 14px; }

    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; background: var(--chip); border-radius: 999px;
      font-size: 12px; color: var(--muted);
    }
    .pill .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--muted); }
    .pill.correct .dot { background: var(--correct); }
    .pill.incorrect .dot { background: var(--incorrect); }

    .result {
      display: grid; gap: 12px; justify-items: center; text-align: center;
      padding: 20px; border-radius: var(--radius); background: var(--card);
      box-shadow: var(--shadow); border: 1px solid rgba(100,116,139,0.12);
    }
    .result h2 { margin: 0; font-size: clamp(20px, 2.5vw, 28px); }
    .result .score { font-size: clamp(18px, 2.2vw, 24px); }
    .result .pct { font-weight: 600; }

    .review {
      display: grid; gap: 14px; margin-top: 12px;
    }
    .review .q {
      padding: 14px; border-radius: 14px; border: 1px solid rgba(100,116,139,0.18);
      background: #fff;
    }
    .review .q h3 { margin: 0 0 6px 0; font-size: 16px; }
    .review .choice-line { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .badge {
      font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f9fafb; color: #374151;
    }
    .badge.correct { border-color: rgba(22,163,74,.35); color: #065f46; background: #ecfdf5; }
    .badge.yours { border-color: rgba(124,58,237,.35); color: #4c1d95; background: #f5f3ff; }
    .badge.wrong { border-color: rgba(220,38,38,.35); color: #7f1d1d; background: #fef2f2; }

    footer { 
      margin-top: 20px; 
      color: var(--muted); 
      font-size: 12px; 
      display: flex; 
      justify-content: center;
      gap: 8px; 
      flex-wrap: wrap;
      margin-top: auto;
      padding-bottom: 20px;
      text-align: center;
    }
    code.kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background: #f3f4f6; padding: 2px 6px; border-radius: 6px; border: 1px solid #e5e7eb; }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <header>
        <div>
          <h1>Quiz</h1>
          <div class="subtitle">Load a quiz JSON and answer sequentially. No going back.</div>
        </div>
        <div class="right">
          <button id="loadJsonBtn" class="btn btn-primary" type="button" title="Load JSON file">Load JSON</button>
          <button id="demoBtn" class="btn" type="button" title="Load a small demo quiz">Load demo</button>
        </div>
      </header>

      <div id="errors" class="errors"></div>

      <!-- Top controls: only progress and restart -->
      <div id="controls" class="controls hidden" aria-hidden="true">
        <div class="left">
          <span id="progress" class="counter"></span>
        </div>
        <div class="right">
          <button id="restartBtn" class="btn" title="Restart">Restart</button>
        </div>
      </div>

      <!-- Quiz card -->
      <section id="card" class="card hidden" aria-live="polite">
        <div>
          <div id="meta" class="pill hidden"><span class="dot"></span><span id="metaText"></span></div>
          <div id="prompt" class="prompt"></div>
          <form id="choicesForm" class="choices" novalidate></form>
          <div style="display:flex; gap:8px; margin-top:14px; justify-content:center;">
            <button id="submitBtn" class="btn btn-primary" type="button">Submit</button>
            <button id="nextBtn" class="btn" type="button">Next â–¶ï¸Ž</button>
          </div>
        </div>
      </section>

      <!-- Tips positioned under the card, same as flashcards.html -->
      <div id="hint" class="hint hidden">Keyboard: <code class="kbd">1..9</code> select/toggle, <code class="kbd">Enter</code> submit.</div>

      <!-- Result screen -->
      <section id="resultView" class="result hidden" aria-live="polite">
        <h2>Results</h2>
        <div class="score">
          <span id="scoreText"></span>
          &nbsp;Â·&nbsp;
          <span id="pctText" class="pct"></span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:6px;">
          <button id="viewMissedBtn" class="btn" type="button">View missed</button>
          <button id="retryBtn" class="btn btn-primary" type="button">Retry</button>
        </div>
      </section>

      <!-- Missed review -->
      <section id="reviewView" class="hidden" aria-live="polite">
        <div class="review" id="reviewList"></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:12px;">
          <button id="backToResultsBtn" class="btn" type="button">Back to results</button>
          <button id="retryFromStartBtn" class="btn btn-primary" type="button">Retry</button>
        </div>
      </section>
    </div>

    <footer>
      <div>Minimal, self-contained. No network, no tracking.</div>
    </footer>
  </div>

  <input id="fileInput" type="file" accept="application/json,.json" class="hidden" />

  <script>
  // ---------- Minimal validator for the quiz schema ----------
  function validateQuiz(quiz) {
    const errors = [];
    const isObject = (v) => v && typeof v === 'object' && !Array.isArray(v);

    if (!isObject(quiz)) return { ok: false, errors: ["Root must be an object."] };

    const allowedRoot = new Set(["title", "version", "description", "questions"]);
    Object.keys(quiz).forEach(k => { if (!allowedRoot.has(k)) errors.push(`Unexpected property at root: "${k}"`); });

    if (typeof quiz.title !== 'string' || quiz.title.trim().length < 1) {
      errors.push('"title" must be a non-empty string.');
    }
    if (!Number.isInteger(quiz.version) || quiz.version < 1) {
      errors.push('"version" must be an integer â‰¥ 1.');
    }
    if (!Array.isArray(quiz.questions) || quiz.questions.length < 1) {
      errors.push('"questions" must be a non-empty array.');
    }

    if (Array.isArray(quiz.questions)) {
      const qids = new Set();
      quiz.questions.forEach((q, i) => {
        const path = `questions[${i}]`;
        if (!isObject(q)) { errors.push(`${path} must be an object.`); return; }

        const allowedQ = new Set(["id", "type", "prompt", "choices", "explanation", "shuffleChoices", "timeLimitSec", "tags"]);
        Object.keys(q).forEach(k => { if (!allowedQ.has(k)) errors.push(`Unexpected property at ${path}: "${k}"`); });

        if (!Number.isInteger(q.id) || q.id < 1) errors.push(`${path}.id must be an integer â‰¥ 1.`);
        else if (qids.has(q.id)) errors.push(`${path}.id must be unique; duplicate id ${q.id}.`); else qids.add(q.id);

        if (q.type !== 'single' && q.type !== 'multiple') errors.push(`${path}.type must be "single" or "multiple".`);

        if (typeof q.prompt !== 'string' || q.prompt.trim().length < 1) errors.push(`${path}.prompt must be a non-empty string.`);

        if (!Array.isArray(q.choices) || q.choices.length < 2) errors.push(`${path}.choices must be an array with at least 2 items.`);

        if (Array.isArray(q.choices)) {
          const cids = new Set();
          let correctCount = 0;
          q.choices.forEach((c, j) => {
            const cpath = `${path}.choices[${j}]`;
            if (!isObject(c)) { errors.push(`${cpath} must be an object.`); return; }
            const allowedC = new Set(["id", "text", "is_correct"]);
            Object.keys(c).forEach(k => { if (!allowedC.has(k)) errors.push(`Unexpected property at ${cpath}: "${k}"`); });

            if (!Number.isInteger(c.id) || c.id < 1) errors.push(`${cpath}.id must be an integer â‰¥ 1.`);
            else if (cids.has(c.id)) errors.push(`${cpath}.id must be unique within question; duplicate id ${c.id}.`); else cids.add(c.id);

            if (typeof c.text !== 'string' || c.text.trim().length < 1) errors.push(`${cpath}.text must be a non-empty string.`);
            if (typeof c.is_correct !== 'boolean') errors.push(`${cpath}.is_correct must be boolean.`);
            else if (c.is_correct) correctCount++;
          });
          if (q.type === 'single' && correctCount !== 1) errors.push(`${path}: "single" must have exactly 1 correct choice.`);
          if (q.type === 'multiple' && correctCount < 2) errors.push(`${path}: "multiple" must have at least 2 correct choices.`);
        }
      });
    }

    return { ok: errors.length === 0, errors };
  }

  // ---------- State ----------
  const state = {
    quiz: null,
    order: [],
    idx: 0,
    locked: false,    // after submit, prevent changing & backtracking
    answers: [],      // array of { qid, type, selectedIds: number[], isCorrect: boolean }
    finished: false
  };

  // ---------- Elements ----------
  const fileInput = document.getElementById('fileInput');
  const loadJsonBtn = document.getElementById('loadJsonBtn');
  const demoBtn = document.getElementById('demoBtn');
  const errorsEl = document.getElementById('errors');
  const controls = document.getElementById('controls');
  const progressEl = document.getElementById('progress');
  const restartBtn = document.getElementById('restartBtn');

  const cardEl = document.getElementById('card');
  const promptEl = document.getElementById('prompt');
  const choicesForm = document.getElementById('choicesForm');
  const submitBtn = document.getElementById('submitBtn');
  const nextBtn = document.getElementById('nextBtn');

  const metaPill = document.getElementById('meta');
  const metaText = document.getElementById('metaText');

  const resultView = document.getElementById('resultView');
  const scoreText = document.getElementById('scoreText');
  const pctText = document.getElementById('pctText');
  const viewMissedBtn = document.getElementById('viewMissedBtn');
  const retryBtn = document.getElementById('retryBtn');

  const reviewView = document.getElementById('reviewView');
  const reviewList = document.getElementById('reviewList');
  const backToResultsBtn = document.getElementById('backToResultsBtn');
  const retryFromStartBtn = document.getElementById('retryFromStartBtn');

  const hintEl = document.getElementById('hint');

  // ---------- File loading ----------
  loadJsonBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if (file) readFile(file);
    fileInput.value = '';
  });

  function readFile(file) {
    if (!/\.json$/i.test(file.name)) {
      showErrors([`File "${file.name}" is not a .json`]);
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        loadQuiz(parsed, false);
      } catch (err) {
        showErrors([`Invalid JSON: ${err.message}`]);
      }
    };
    reader.onerror = () => showErrors([`Could not read file: ${reader.error?.message || 'Unknown error'}`]);
    reader.readAsText(file);
  }

  // ---------- Quiz lifecycle ----------
  function loadQuiz(quiz, isDemo = true) {
    const res = validateQuiz(quiz);
    if (!res.ok) { showErrors(res.errors); return; }

    hideErrors();
    state.quiz = quiz;
    state.order = quiz.questions.map((_, i) => i); // deterministic order
    state.idx = 0;
    state.locked = false;
    state.answers = [];
    state.finished = false;

    // Views
    controls.classList.remove('hidden');
    controls.setAttribute('aria-hidden', 'false');
    cardEl.classList.remove('hidden');
    resultView.classList.add('hidden');
    reviewView.classList.add('hidden');

    metaPill.classList.add('hidden');
    nextBtn.disabled = true;

    // Show hint when quiz is loaded
    hintEl.classList.remove('hidden');

    updateProgress();
    renderQuestion();
    focusFirstInteractive();
    if (!isDemo) demoBtn.classList.add('hidden');
  }

  function restart() {
    if (!state.quiz) return;
    state.idx = 0;
    state.locked = false;
    state.answers = [];
    state.finished = false;

    cardEl.classList.remove('hidden');
    resultView.classList.add('hidden');
    reviewView.classList.add('hidden');
    metaPill.classList.add('hidden');
    nextBtn.disabled = true;

    // Show hint when restarting
    hintEl.classList.remove('hidden');

    updateProgress();
    renderQuestion();
    focusFirstInteractive();
  }

  function renderQuestion() {
    const q = currentQuestion(); if (!q) return;

    promptEl.textContent = q.prompt;
    choicesForm.innerHTML = '';

    // Maybe shuffle per-question if q.shuffleChoices === true
    const choices = q.shuffleChoices === false ? [...q.choices] : shuffled([...q.choices]);

    // Build inputs
    const name = `q_${q.id}`;
    choices.forEach((c, i) => {
      const wrap = document.createElement('label');
      wrap.className = 'choice';
      const input = document.createElement('input');
      input.type = (q.type === 'single') ? 'radio' : 'checkbox';
      input.name = name;
      input.value = String(c.id);
      input.dataset.choiceId = String(c.id);
      input.style.marginTop = '2px';

      const span = document.createElement('div');
      span.className = 'label';
      span.textContent = c.text;

      wrap.appendChild(input);
      wrap.appendChild(span);
      choicesForm.appendChild(wrap);
    });

    state.locked = false;
    submitBtn.disabled = false;
    nextBtn.disabled = true;
    metaPill.className = 'pill hidden'; // reset
    metaText.textContent = '';
  }

  function currentQuestion() {
    return state.quiz?.questions[state.order[state.idx]];
  }

  function updateProgress() {
    if (!state.quiz) return;
    progressEl.textContent = `Question ${state.idx + 1} / ${state.order.length}`;
  }

  function collectSelection() {
    const q = currentQuestion(); if (!q) return [];
    const inputs = [...choicesForm.querySelectorAll('input')];
    const selected = inputs.filter(i => i.checked).map(i => Number(i.dataset.choiceId));
    return selected;
  }

  function grade(q, selectedIds) {
    const correctIds = q.choices.filter(c => c.is_correct).map(c => c.id).sort((a,b)=>a-b);
    const picked = [...selectedIds].sort((a,b)=>a-b);
    if (q.type === 'single') {
      return picked.length === 1 && correctIds.length === 1 && picked[0] === correctIds[0];
    } else {
      // multiple: exact set match (all correct selected, no incorrect selected)
      if (picked.length !== correctIds.length) return false;
      for (let i = 0; i < picked.length; i++) if (picked[i] !== correctIds[i]) return false;
      return true;
    }
  }

  function lockQuestionFeedback(isCorrect, selectedIds) {
    state.locked = true;
    submitBtn.disabled = true;

    const q = currentQuestion();
    const inputs = [...choicesForm.querySelectorAll('input')];

    // Visual feedback on choices
    const correctSet = new Set(q.choices.filter(c => c.is_correct).map(c => c.id));
    const selectedSet = new Set(selectedIds);

    inputs.forEach(input => {
      const id = Number(input.dataset.choiceId);
      const label = input.closest('.choice');
      input.disabled = true;

      if (correctSet.has(id)) label.classList.add('correct');
      if (selectedSet.has(id) && !correctSet.has(id)) label.classList.add('incorrect');
      if (!selectedSet.has(id) && !correctSet.has(id)) label.classList.add('disabled');
    });

    // Meta pill
    metaPill.classList.remove('hidden');
    metaPill.classList.toggle('correct', isCorrect);
    metaPill.classList.toggle('incorrect', !isCorrect);
    metaPill.classList.add(isCorrect ? 'correct' : 'incorrect');
    metaText.textContent = isCorrect ? 'Correct' : 'Incorrect';

    // Enable moving forward only
    nextBtn.disabled = false;
    nextBtn.focus();
  }

  function submitCurrent() {
    if (!state.quiz || state.locked) return;

    const q = currentQuestion();
    const selected = collectSelection();

    // Require a selection
    if (selected.length === 0) {
      showTransientError('Please select an answer.');
      return;
    }

    const isCorrect = grade(q, selected);

    // Record immutable answer (prevents going back)
    state.answers.push({
      qid: q.id,
      type: q.type,
      selectedIds: selected.slice(),
      isCorrect
    });

    lockQuestionFeedback(isCorrect, selected);
  }

  function nextQuestionOrFinish() {
    if (!state.quiz) return;
    if (!state.locked) return; // must submit first

    if (state.idx < state.order.length - 1) {
      state.idx++;
      updateProgress();
      renderQuestion();
      focusFirstInteractive();
    } else {
      // Finish - hide hint when showing results
      hintEl.classList.add('hidden');
      state.finished = true;
      showResults();
    }
  }

  function showResults() {
    // Hide question card
    cardEl.classList.add('hidden');

    const total = state.order.length;
    const correct = state.answers.filter(a => a.isCorrect).length;
    const pct = total > 0 ? Math.round((correct / total) * 1000) / 10 : 0;

    scoreText.textContent = `${correct} / ${total} correct`;
    pctText.textContent = `${pct}%`;

    resultView.classList.remove('hidden');
    reviewView.classList.add('hidden');
  }

  function buildMissedReview() {
    reviewList.innerHTML = '';
    const missed = state.answers.filter(a => !a.isCorrect);
    const qById = new Map(state.quiz.questions.map(q => [q.id, q]));

    if (missed.length === 0) {
      const div = document.createElement('div');
      div.className = 'q';
      div.innerHTML = '<h3>No mistakes ðŸŽ‰</h3><div>All questions answered correctly.</div>';
      reviewList.appendChild(div);
      return;
    }

    missed.forEach(a => {
      const q = qById.get(a.qid);
      const correctSet = new Set(q.choices.filter(c => c.is_correct).map(c => c.id));
      const selectedSet = new Set(a.selectedIds);

      const wrap = document.createElement('div');
      wrap.className = 'q';

      const h3 = document.createElement('h3');
      h3.textContent = q.prompt;
      wrap.appendChild(h3);

      q.choices.forEach(c => {
        const line = document.createElement('div');
        line.className = 'choice-line';

        const parts = [];
        if (correctSet.has(c.id)) {
          const b = document.createElement('span'); b.className = 'badge correct'; b.textContent = 'correct';
          parts.push(b);
        }
        if (selectedSet.has(c.id) && !correctSet.has(c.id)) {
          const b = document.createElement('span'); b.className = 'badge wrong'; b.textContent = 'your pick';
          parts.push(b);
        }
        if (selectedSet.has(c.id) && correctSet.has(c.id)) {
          const b = document.createElement('span'); b.className = 'badge yours'; b.textContent = 'your pick';
          parts.push(b);
        }

        const text = document.createElement('span');
        text.textContent = c.text;

        parts.forEach(p => line.appendChild(p));
        line.appendChild(text);
        wrap.appendChild(line);
      });

      if (q.explanation) {
        const exp = document.createElement('div');
        exp.style.marginTop = '6px';
        exp.style.color = 'var(--muted)';
        exp.style.fontSize = '13px';
        exp.textContent = q.explanation;
        wrap.appendChild(exp);
      }

      reviewList.appendChild(wrap);
    });
  }

  function focusFirstInteractive() {
    const first = choicesForm.querySelector('input');
    if (first) first.focus();
  }

  function showErrors(errs) {
    errorsEl.innerHTML = '';
    (Array.isArray(errs) ? errs : [String(errs)]).forEach(msg => {
      const div = document.createElement('div');
      div.className = 'error';
      div.textContent = msg;
      errorsEl.appendChild(div);
    });
    errorsEl.classList.remove('hidden');
  }
  function hideErrors() { errorsEl.classList.add('hidden'); errorsEl.innerHTML = ''; }
  function showTransientError(msg) {
    showErrors([msg]);
    setTimeout(() => hideErrors(), 1500);
  }

  function shuffled(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ---------- Controls & Keys ----------
  submitBtn.addEventListener('click', submitCurrent);
  nextBtn.addEventListener('click', nextQuestionOrFinish);
  restartBtn.addEventListener('click', restart);
  retryBtn.addEventListener('click', restart);
  retryFromStartBtn.addEventListener('click', restart);

  viewMissedBtn.addEventListener('click', () => {
    buildMissedReview();
    resultView.classList.add('hidden');
    reviewView.classList.remove('hidden');
  });
  backToResultsBtn.addEventListener('click', () => {
    reviewView.classList.add('hidden');
    resultView.classList.remove('hidden');
  });

  document.addEventListener('keydown', (e) => {
    if (!state.quiz || state.finished) return;

    const q = currentQuestion(); if (!q) return;

    // number keys 1..9 to toggle/select choices
    if (e.key >= '1' && e.key <= '9') {
      const idx = Number(e.key) - 1;
      const inputs = [...choicesForm.querySelectorAll('input')];
      if (idx < inputs.length && !state.locked) {
        const input = inputs[idx];
        if (q.type === 'single') {
          inputs.forEach(i => i.checked = false);
          input.checked = true;
        } else {
          input.checked = !input.checked;
        }
        e.preventDefault();
      }
    } else if (e.key === 'Enter') {
      // Enter submits if not yet locked, otherwise goes next
      if (!state.locked) {
        e.preventDefault();
        submitCurrent();
      } else {
        e.preventDefault();
        nextQuestionOrFinish();
      }
    }
  });

  // ---------- Demo quiz (conforms to the schema we defined) ----------
  const demoQuiz = {
    title: "Sample Quiz: Basics",
    version: 1,
    questions: [
      {
        id: 1,
        type: "single",
        prompt: "Which planet is known as the Red Planet?",
        choices: [
          { id: 1, text: "Venus", is_correct: false },
          { id: 2, text: "Mars", is_correct: true },
          { id: 3, text: "Jupiter", is_correct: false }
        ],
        explanation: "Mars appears red due to iron oxide on its surface."
      },
      {
        id: 2,
        type: "multiple",
        prompt: "Select all prime numbers.",
        choices: [
          { id: 1, text: "2", is_correct: true },
          { id: 2, text: "3", is_correct: true },
          { id: 3, text: "4", is_correct: false },
          { id: 4, text: "5", is_correct: true }
        ],
        explanation: "A prime number has exactly two divisors: 1 and itself."
      },
      {
        id: 3,
        type: "single",
        prompt: "What is the chemical symbol for water?",
        choices: [
          { id: 1, text: "H2O", is_correct: true },
          { id: 2, text: "O2", is_correct: false },
          { id: 3, text: "CO2", is_correct: false }
        ],
        explanation: "Two hydrogen atoms and one oxygen atom."
      }
    ]
  };

  demoBtn.addEventListener('click', () => loadQuiz(demoQuiz, true));
  </script>
</body>
</html>
